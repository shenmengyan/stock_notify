<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å°è‚¡æ¸¬è©¦é€šçŸ¥</title>
</head>
<body>
  <h2>ğŸ“¢ æ¸¬è©¦ç‰ˆï¼šæ¯åˆ†é˜é€šçŸ¥ä¸€æ¬¡ï¼ˆå«é™¤éŒ¯ï¼‰</h2>
  <button onclick="start()">é»æ“Šé–‹å§‹æ¥æ”¶é€šçŸ¥</button>

<script>
let openPrices = {
  taiex: null,
  tsmc: null
};

function notify(msg) {
  if (Notification.permission === 'granted') {
    new Notification(msg);
  } else {
    Notification.requestPermission().then(p => {
      if (p === 'granted') new Notification(msg);
    });
  }
}

function getPercentChange(current, open) {
  return ((current - open) / open * 100).toFixed(2);
}

async function fetchData() {
  const today = new Date().toISOString().split('T')[0];
  let taiex = null;
  let tsmc = null;

  try {
    const taiexRes = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=TAIEX&start_date=${today}`);
    const taiexData = await taiexRes.json();
    const data = taiexData.data || [];
    if (data.length > 0) {
      const open = parseFloat(data[0].open);
      const close = parseFloat(data[data.length - 1].close);
      taiex = { open, close };
    }
  } catch (e) {
    console.error('å°è‚¡è³‡æ–™å¤±æ•—', e);
  }

  try {
    const tsmcRes = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=2330&start_date=${today}`);
    const tsmcData = await tsmcRes.json();
    const data = tsmcData.data || [];
    if (data.length > 0) {
      const open = parseFloat(data[0].open);
      const close = parseFloat(data[data.length - 1].close);
      tsmc = { open, close };
    }
  } catch (e) {
    console.error('å°ç©é›»è³‡æ–™å¤±æ•—', e);
  }

  return { taiex, tsmc };
}

async function sendSummary() {
  const { taiex, tsmc } = await fetchData();

  if (!taiex || !tsmc) {
    notify('âŒ è³‡æ–™å°šæœªæº–å‚™å¥½ï¼Œè·³éé€™ä¸€è¼ª');
    return;
  }

  if (!openPrices.taiex) openPrices.taiex = taiex.open;
  if (!openPrices.tsmc) openPrices.tsmc = tsmc.open;

  const taiexDiff = taiex.close - openPrices.taiex;
  const taiexPercent = getPercentChange(taiex.close, openPrices.taiex);
  const tsmcDiff = tsmc.close - openPrices.tsmc;
  const tsmcPercent = getPercentChange(tsmc.close, openPrices.tsmc);

  const msg =
`ğŸ“ˆ å°è‚¡ç›®å‰
