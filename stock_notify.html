<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å°è‚¡ç›£æ§é€šçŸ¥å™¨</title>
</head>
<body>
  <h2>ğŸ“¢ å°è‚¡å³æ™‚ç›£æ§ä¸­...</h2>
  <p>ä¿æŒé€™å€‹é é¢é–‹è‘—å°±å¯ä»¥æ”¶åˆ°é€šçŸ¥ã€‚</p>

<script>
const importantPoints = [18000, 19000, 20000, 21000, 22000];
const tsmcPoints = [800, 900, 1000, 1100, 1200];

async function fetchData() {
  const today = new Date().toISOString().split('T')[0];

  const indexResp = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=TAIEX&start_date=${today}`);
  const indexData = await indexResp.json();
  const indexList = indexData.data;
  if (indexList.length === 0) return;

  const open = parseFloat(indexList[0].open);
  const close = parseFloat(indexList[indexList.length - 1].close);
  const diff = close - open;

  if (Math.abs(diff) >= 1000) {
    notify(`âš ï¸ å°è‚¡ä»Šå¤©å·²ç¶“ ${diff > 0 ? 'ä¸Šæ¼²' : 'ä¸‹è·Œ'} è¶…é 1000 é»ï¼Œç›®å‰è®Šå‹•ï¼š${diff.toFixed(2)} é»`);
  }

  for (let point of importantPoints) {
    if (Math.abs(close - point) <= 10) {
      notify(`ğŸ“ˆ å°è‚¡ç›®å‰æ¥è¿‘æ•´æ•¸é»ï¼š${point}ï¼ˆç¾åœ¨ï¼š${close.toFixed(2)}ï¼‰`);
      break;
    }
  }

  const tsmcResp = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=2330&start_date=${today}`);
  const tsmcData = await tsmcResp.json();
  const tsmcList = tsmcData.data;
  if (tsmcList.length === 0) return;

  const tsmcClose = parseFloat(tsmcList[tsmcList.length - 1].close);
  for (let point of tsmcPoints) {
    if (Math.abs(tsmcClose - point) <= 5) {
      notify(`ğŸ’¡ å°ç©é›»è‚¡åƒ¹æ¥è¿‘ ${point} å…ƒï¼ˆç¾åœ¨ï¼š${tsmcClose.toFixed(2)} å…ƒï¼‰`);
      break;
    }
  }
}

function notify(msg) {
  if (Notification.permission === "granted") {
    new Notification(msg);
  } else if (Notification.permission !== "denied") {
    Notification.requestPermission().then(p => {
      if (p === "granted") new Notification(msg);
    });
  }
}

fetchData();
setInterval(fetchData, 5 * 60 * 1000);
</script>
</body>
</html>
