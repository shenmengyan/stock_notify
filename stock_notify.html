<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å°è‚¡ç›£æ§é€šçŸ¥å™¨</title>
</head>
<body>
  <h2>ğŸ“ˆ å°è‚¡ & å°ç©é›» å³æ™‚ç›£æ§ä¸­...</h2>
  <button onclick="start()">é»æ“Šé–‹å§‹æ¥æ”¶é€šçŸ¥</button>

<script>
const taiexPoints = [18000, 19000, 20000, 21000, 22000];
const tsmcPoints = [800, 900, 1000, 1100, 1200];

function notify(msg) {
  if (Notification.permission === 'granted') {
    new Notification(msg);
  } else {
    Notification.requestPermission().then(p => {
      if (p === 'granted') new Notification(msg);
    });
  }
}

async function checkMarket() {
  const today = new Date().toISOString().split('T')[0];

  // å°è‚¡åŠ æ¬ŠæŒ‡æ•¸
  try {
    const taiexRes = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=TAIEX&start_date=${today}`);
    const taiexData = await taiexRes.json();
    const data = taiexData.data;
    if (data.length > 0) {
      const open = parseFloat(data[0].open);
      const close = parseFloat(data[data.length - 1].close);
      const diff = close - open;

      if (Math.abs(diff) > 1000) {
        notify(`âš ï¸ å°è‚¡ä»Šæ—¥${diff > 0 ? 'ä¸Šæ¼²' : 'ä¸‹è·Œ'}è¶…é1000é»ï¼š${diff.toFixed(2)}é»`);
      }

      for (let point of taiexPoints) {
        if (Math.abs(close - point) < 10) {
          notify(`ğŸ¯ å°è‚¡æ¥è¿‘æ•´æ•¸é» ${point}ï¼Œç›®å‰ ${close.toFixed(2)} é»`);
          break;
        }
      }
    }
  } catch (e) {
    console.error('å°è‚¡è³‡æ–™éŒ¯èª¤', e);
  }

  // å°ç©é›»
  try {
    const tsmcRes = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=2330&start_date=${today}`);
    const tsmcData = await tsmcRes.json();
    const data = tsmcData.data;
    if (data.length > 0) {
      const price = parseFloat(data[data.length - 1].close);
      for (let point of tsmcPoints) {
        if (Math.abs(price - point) < 5) {
          notify(`ğŸŸ å°ç©é›»è‚¡åƒ¹æ¥è¿‘ ${point} å…ƒï¼Œç›®å‰ ${price.toFixed(2)} å…ƒ`);
          break;
        }
      }
    }
  } catch (e) {
    console.error('å°ç©é›»è³‡æ–™éŒ¯èª¤', e);
  }
}

function start() {
  notify("âœ… é€šçŸ¥å·²å•Ÿå‹•ï¼Œæ¯ 5 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ï¼");
  checkMarket();
  setInterval(checkMarket, 5 * 60 * 1000); // æ¯ 5 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
}
</script>
</body>
</html>
